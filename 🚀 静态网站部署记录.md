# ğŸš€ é™æ€ç½‘ç«™éƒ¨ç½²è®°å½•

> äº‘æœåŠ¡å™¨ï¼Œç®€å•æ¥è¯´ï¼Œå°±æ˜¯ä¸€å°24/7åœ¨çº¿çš„è®¡ç®—æœºï¼Œé€šè¿‡å…¬ç½‘å¯ä»¥è®¿é—®å…¶ä¸­çš„æ–‡ä»¶ã€‚

## ä¸€ã€æœåŠ¡å™¨é…ç½®

1. åœ¨å¸‚åœºä¸Šï¼Œæœ‰è®¸å¤šæœåŠ¡å™¨å‚å•†å¯ä¾›é€‰æ‹©ï¼Œä¾‹å¦‚ [é˜¿é‡Œäº‘](https://ecs.console.aliyun.com/)ã€[è…¾è®¯äº‘](https://cloud.tencent.com/)ã€[äº¬ä¸œäº‘](https://login.jdcloud.com/)ã€[åä¸ºäº‘](https://activity.huaweicloud.com/)ç­‰ã€‚æ ¹æ®ä¸ªäººéœ€æ±‚é€‰æ‹©åˆé€‚çš„äº‘æœåŠ¡å™¨ã€‚

2. ç³»ç»Ÿé€‰æ‹©å¯ä¾ä¸ªäººåå¥½ï¼Œæˆ‘é€‰æ‹©äº† Ubuntu ä½œä¸ºæœåŠ¡å™¨æ“ä½œç³»ç»Ÿã€‚

3. è´­ä¹°åï¼Œéœ€è¿›è¡Œå¯†ç é‡ç½®ï¼Œä»¥æ–¹ä¾¿ä½¿ç”¨ SSH ç™»å½•ã€‚

   - å…·ä½“æ­¥éª¤ä¸ºï¼šäº‘æœåŠ¡å™¨ ECS > å®ä¾‹ > ç¤ºä¾‹è¯¦æƒ…ã€‚

4. ssh ç™»å½•æµ‹è¯•

   - é€šè¿‡`ssh <user_host>` æˆ– `ssh <user_account>@<user_host>`è¿›è¡Œç™»å½•ã€‚è‹¥å¯†ç ç™»å½•å¤±è´¥ï¼Œå¯å°è¯•[æ­¤æ–¹å¼](https://help.aliyun.com/zh/ecs/support/what-do-i-do-if-the-permission-denied-please-try-again-error-message-appears-when-i-log-on-to-a-linux-instance-as-the-root-user-by-using-ssh#144ae4409775t)ã€‚

   - ç¬¬ä¸€æ¬¡ç™»å½•éœ€è¿›è¡ŒæŒ‡çº¹åˆ›å»ºï¼Œä»¥é˜²[ä¸­é—´äººæ”»å‡»](https://zh.wikipedia.org/wiki/ä¸­é—´äººæ”»å‡»)ã€‚

     ```bash
     The authenticity of host '<user_host>' can't be established.
     ED25519 key fingerprint is SHA256:SaNyCX940ieblSBaRWABfKOSa45ZdlusT5UxKVd5m8s.
     This key is not known by any other names.
     Are you sure you want to continue connecting (yes/no/[fingerprint])?
     ```

   - ç™»å½•æˆåŠŸåï¼Œä¼šè¾“å‡ºç³»ç»Ÿä¿¡æ¯ã€‚å¦‚è§‰å¾—æ¯æ¬¡è¾“å…¥å¯†ç éº»çƒ¦ï¼Œå¯è®¾ç½®[å…å¯†ç™»å½•](https://developer.aliyun.com/article/1132156)ä»¥æé«˜ä¾¿åˆ©æ€§ã€‚

     ```bash
     Welcome to Ubuntu 22.04.3 LTS (GNU/Linux 5.15.0-88-generic x86_64)
     
      * Documentation:  https://help.ubuntu.com
      * Management:     https://landscape.canonical.com
      * Support:        https://ubuntu.com/advantage
     
       System information as of Fri Jan 12 06:24:17 PM CST 2024
     
       System load:  0.0               Processes:             120
       Usage of /:   9.0% of 39.01GB   Users logged in:       0
       Memory usage: 18%               IPv4 address for eth0: 172.17.54.201
       Swap usage:   0%
     
      * Strictly confined Kubernetes makes edge and IoT secure. Learn how MicroK8s
        just raised the bar for easy, resilient and secure K8s cluster deployment.
     
        https://ubuntu.com/engage/secure-kubernetes-at-the-edge
     
     Expanded Security Maintenance for Applications is not enabled.
     
     23 updates can be applied immediately.
     To see these additional updates run: apt list --upgradable
     
     2 additional security updates can be applied with ESM Apps.
     Learn more about enabling ESM Apps service at https://ubuntu.com/esm
     
     
     *** System restart required ***
     
     Welcome to Alibaba Cloud Elastic Compute Service !
     
     Last login: Fri Jan 12 14:11:52 2024 from 123.120.56.167
     ```

5. é…ç½®äº‘æœåŠ¡å™¨å®‰å…¨ç»„ï¼Œå¼€æ”¾`http:80`å’Œ`https:443`ç«¯å£ï¼Œä¾›å¤–ç½‘è®¿é—®ã€‚

   ![image-20240113ä¸‹åˆ102458663](https://static.rux.ink/uPic/image-20240113%E4%B8%8B%E5%8D%88102458663.png)

6. é…ç½® `Nginx` åå‘ä»£ç†[âŒ˜](https://zhuanlan.zhihu.com/p/331034334)ã€‚

   - ä¸‹è½½ Nginx

     ```bash
     sudo apt update && sudo apt install nginx
     ```

   - æ£€æŸ¥æ˜¯å¦ä¸‹è½½å®Œæ¯•

     ```bash
     nginx -v
     ```

   - å¯åŠ¨ Nginx

     ```bash
     sudo systemctl start nginx
     ```

     é€šè¿‡æµè§ˆå™¨è®¿é—®ä½ çš„ `<user_host>`ï¼Œå¦‚æœå‡ºç°ä»¥ä¸‹é¡µé¢è¯´æ˜ Nginx å¯åŠ¨æˆåŠŸã€‚
   
     ![image-20240114ä¸Šåˆ12109801](https://static.rux.ink/uPic/image-20240114%E4%B8%8A%E5%8D%8812109801.png)
   
     - å¯èƒ½å‡ºç°çš„å¤±è´¥æ¡ˆä¾‹ï¼š
     
       ```bash
       âœ  nginx nginx
       nginx: [emerg] getpwnam("nginx") failed in /etc/nginx/nginx.conf:2
       ```
     
       ```bash
       âœ  nginx systemctl start nginx
       Job for nginx.service failed because the control process exited with error code.
       See "systemctl status nginx.service" and "journalctl -xeu nginx.service" for details.
       ```
     
       ```bash
       âœ  nginx tail /var/log/nginx/error.log
       2024/01/14 01:37:16 [crit] 38147#38147: *8 stat() "/root/Desktop/zilean/" failed (13: Permission denied), client: 123.120.53.112, server: www.rux.ink, request: "GET / HTTP/1.1", host: "www.rux.ink"
       ```
       
     - æœ‰å¯èƒ½æ˜¯å› ä¸ºæƒé™ä¸è¶³å¯¼è‡´çš„å¯åŠ¨å¤±è´¥ï¼Œä¿®æ”¹ `nginx.conf user` ä¸º `root` é‡æ–°å¯åŠ¨ `nginx`
     
       ```bash
       âœ  nginx vim nginx.conf
       ```
       
     
   - ä¿®æ”¹ `/etc/nginx/sites-available/default` æ–‡ä»¶ï¼š
   
     ```nginx
     server {
         listen 80;
       	
       	# default_server é»˜è®¤ä¸ºæœåŠ¡å™¨hostï¼Œç”¨äºè‡ªå®šä¹‰åŸŸå
         server_name default_server;
     
     		# ä¿®æ”¹ target_path è‡ªå®šä¹‰è·¯å¾„
         root target_path;
       
         index index.html;
     
         location / {
             # å°è¯•æŸ¥æ‰¾è¯·æ±‚çš„æ–‡ä»¶ï¼Œå¦‚æœæ‰¾ä¸åˆ°åˆ™è¿”å› 404
             try_files $uri $uri/ =404;
         }
     
         error_page 500 502 503 504 /50x.html;
         location = /50x.html {
             root /usr/share/nginx/html;
         }
     }
     ```
   
     ä¹Ÿå¯ä»¥æ–°å»º `your_config_file` æ–‡ä»¶ç”¨äºé¡¹ç›®ä»£ç†ï¼Œæ›¿æ¢ `your_config_file` ä¸ºä½ åˆ›å»ºçš„é…ç½®æ–‡ä»¶åã€‚
   
     - æ–°å»ºé…ç½®æ–‡ä»¶ï¼š
   
       ```bash
       touch /etc/nginx/sites-available/your_config_file && vim your_config_file
       ```
   
     - é…ç½®å†…å®¹ä¸ä¸Šæ–‡çš„ `default` æ–‡ä»¶ä¸€è‡´ï¼Œæ•…çœç•¥ã€‚
   
     - åœ¨ `/etc/nginx/sites-enabled/` ç›®å½•ä¸‹åˆ›å»ºç¬¦å·é“¾æ¥ï¼š
   
       ```bash
       sudo ln -s /etc/nginx/sites-available/your_config_file /etc/nginx/sites-enabled/
       ```
   
     - æ£€æŸ¥ Nginx é…ç½®æ˜¯å¦æ­£ç¡®ï¼š
   
       ```bash
       sudo nginx -t
       ```
   
       å¦‚æœæ²¡æœ‰é”™è¯¯ï¼Œå°†æ˜¾ç¤º `nginx: configuration file /etc/nginx/nginx.conf test is successful`ã€‚
   
     - é‡å¯ Nginx æœåŠ¡
   
       ```bash
       sudo systemctl restart nginx
       ```
   
       ç°åœ¨ï¼Œä½ çš„æ–°é…ç½®æ–‡ä»¶åº”è¯¥å·²ç»ç”Ÿæ•ˆã€‚ä½ å¯ä»¥æŒ‰ç…§è¿™ä¸ªæ¨¡æ¿ä¸ºæ¯ä¸ªåº”ç”¨ç¨‹åºæˆ–ç«™ç‚¹åˆ›å»ºå•ç‹¬çš„é…ç½®æ–‡ä»¶ã€‚



## äºŒã€é¡¹ç›®éƒ¨ç½²

> é€šè¿‡ä¸Šè¿°é…ç½®ï¼Œæˆ‘ä»¬åªéœ€å°† `.html` æ–‡ä»¶ä¸Šä¼ è‡³ `target_path` å³å¯å®ç°å…¬ç½‘è®¿é—®ã€‚
>
> æ–‡ä»¶è¿œç¨‹æ¨é€æœ‰å¤šç§æ–¹å¼ï¼Œä»¥ä¸‹æ˜¯ä¸¤ç§å¸¸ç”¨æ–¹æ³•ã€‚

### ä½¿ç”¨ SCP

1. ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å°†æ–‡ä»¶ä»æœ¬åœ°ç³»ç»Ÿå¤åˆ¶åˆ°è¿œç¨‹æœåŠ¡å™¨ï¼š

   ```bash
   scp /path/to/local/file username@remote_server:/path/to/destination/
   ```

   - `/path/to/local/file` æ˜¯æœ¬åœ°æ–‡ä»¶è·¯å¾„ã€‚
   - `username` æ˜¯è¿œç¨‹æœåŠ¡å™¨ä¸Šçš„ç”¨æˆ·åã€‚
   - `remote_server` æ˜¯è¿œç¨‹æœåŠ¡å™¨çš„ IP åœ°å€æˆ–åŸŸåã€‚
   - `/path/to/destination/` æ˜¯è¿œç¨‹æœåŠ¡å™¨ä¸Šçš„ç›®æ ‡è·¯å¾„ã€‚

   ç¤ºä¾‹ï¼š

   ```bash
   scp /Desktop/zilean/dist root@192.168.1.100:/root/Desktop/zilean
   ```

2. è¾“å…¥ç”¨æˆ·å¯†ç ï¼ˆæˆ–å¦‚æœé…ç½®äº† SSH å…¬é’¥ï¼Œå¯èƒ½éœ€è¦è¾“å…¥ SSH å¯†é’¥å¯†ç ï¼‰ã€‚

### ä½¿ç”¨ Rsync

`rsync` æ˜¯ä¸€ä¸ªæ›´å¼ºå¤§çš„å·¥å…·ï¼Œå¯ä»¥åœ¨å¤šæ¬¡ä¼ è¾“ä¸­ä»…ä¼ è¾“æ–‡ä»¶çš„å˜åŒ–éƒ¨åˆ†ï¼Œä»è€Œæé«˜æ–‡ä»¶åŒæ­¥æ•ˆç‡ã€‚

1. ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å°†æ–‡ä»¶ä»æœ¬åœ°ç³»ç»ŸåŒæ­¥åˆ°è¿œç¨‹æœåŠ¡å™¨ï¼š

   ```bash
   rsync -avz -e "ssh" /path/to/local/file username@remote_server:/path/to/destination/
   ```

   å‚æ•°è¯´æ˜ï¼š

   - `-avz`: `a` è¡¨ç¤ºé€’å½’å¤åˆ¶ï¼Œ`v` è¡¨ç¤ºè¯¦ç»†æ¨¡å¼ï¼Œ`z` è¡¨ç¤ºå‹ç¼©ä¼ è¾“ã€‚
   - `-e "ssh"`: æŒ‡å®šä½¿ç”¨ SSH åè®®ã€‚

   ç¤ºä¾‹ï¼š

   ```bash
   rsync -avz -e "ssh" /Desktop/zilean/dist root@192.168.1.100:/root/Desktop/zilean
   ```

2. è¾“å…¥ç”¨æˆ·å¯†ç ï¼ˆæˆ–å¦‚æœé…ç½®äº† SSH å…¬é’¥ï¼Œå¯èƒ½éœ€è¦è¾“å…¥ SSH å¯†é’¥å¯†ç ï¼‰ã€‚

ç¡®ä¿æ¨é€çš„ç›®æ ‡è·¯å¾„æ­£ç¡®ã€‚é€šè¿‡è¿™äº›æ–¹æ³•ï¼Œä¾¿å¯ä»¥å°†æ–‡ä»¶ä¸Šä¼ åˆ°æœåŠ¡å™¨ï¼Œå®ç°è¿œç¨‹éƒ¨ç½²ã€‚



## ä¸‰ã€å¼•å…¥è‡ªåŠ¨åŒ–ï¼Œç®€åŒ–éƒ¨ç½²æ“ä½œ

> åˆ©ç”¨ GitHub Actionsï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ `git push` çš„æ–¹å¼å‘æœåŠ¡å™¨ä¸Šä¼ æ–‡ä»¶ï¼Œå®ç°å‰ç«¯é¡¹ç›®çš„è‡ªåŠ¨åŒ–éƒ¨ç½²ã€‚

### é€‰æ‹©åˆ›å»ºå·¥ä½œæµ

åœ¨ Actions ä¸­é€‰æ‹©æ¨¡æ¿åˆ›å»ºï¼Œæˆ–è€…åœ¨é¡¹ç›®ä¸­çš„ `.github/workflows/` ç›®å½•ä¸‹åˆ›å»ºä½ çš„ `YML` æ–‡ä»¶ã€‚

![image-20240114ä¸Šåˆ31626749](https://static.rux.ink/uPic/image-20240114%E4%B8%8A%E5%8D%8831626749.png)

### ä¿®æ”¹YMLæ–‡ä»¶

```yml
name: Deploy to Aliyun OSS

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [20.x]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Cache node_modules
        uses: actions/cache@v3
        with:
          path: node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}

      - name: Install node_modules
        run: npm install

      - name: Build
        run: npm run build

      - name: SSH Deploy
        uses: easingthemes/ssh-deploy@v5.0.0
        with:
          # SSH ç§é’¥
          SSH_PRIVATE_KEY: ${{ secrets.ALIYUN_SERVER_SSH_KEY }}
          # è¿œç¨‹ä¸»æœºåœ°å€
          REMOTE_HOST: ${{ secrets.ALIYUN_SERVER_HOST }}
          # è¿œç¨‹ç”¨æˆ·
          REMOTE_USER: root
          # æºç›®å½•ï¼Œç›¸å¯¹äº $GITHUB_WORKSPACE æ ¹ç›®å½•ï¼Œä¾‹å¦‚ï¼šdist/
          SOURCE: ./dist/*
          # ç›®æ ‡ç›®å½•
          TARGET: /root/Desktop/zilean
          # ä¼ é€’ç»™ rsync çš„å‚æ•°
          ARGS: -rlgoDzvc -i
          # ç”¨é€—å·åˆ†éš”çš„æ’é™¤è·¯å¾„ï¼Œä¾‹å¦‚ï¼š/node_modules/
          EXCLUDE: /node_modules/
          # åœ¨ rsync ä¹‹å‰åœ¨ä¸»æœºä¸Šè¿è¡Œçš„è„šæœ¬
          SCRIPT_BEFORE: |
            # æ£€æŸ¥ TARGET ç›®æ ‡è·¯å¾„æ˜¯å¦å­˜åœ¨ï¼Œä¸å­˜åœ¨åˆ™åˆ›å»º
            if [ ! -d "/root/Desktop/zilean" ]; then
              mkdir -p "/root/Desktop/zilean"
            fi
          # åœ¨ rsync ä¹‹ååœ¨ä¸»æœºä¸Šè¿è¡Œçš„è„šæœ¬
          SCRIPT_AFTER: |
            echo "After deploy script"
```

### å®šä¹‰æ‰“åŒ…æ—¶å…¨å±€å˜é‡

![image-20240114ä¸Šåˆ32814075](https://static.rux.ink/uPic/image-20240114%E4%B8%8A%E5%8D%8832814075.png)

### Pushæµ‹è¯•

![image-20240114ä¸Šåˆ33653960](https://static.rux.ink/uPic/image-20240114%E4%B8%8A%E5%8D%8833653960.png)
![image-20240114ä¸Šåˆ34354429](https://static.rux.ink/uPic/image-20240114%E4%B8%8A%E5%8D%8834354429.png)